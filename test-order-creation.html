<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order Creation - Eurodoor</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Order Creation - Eurodoor</h1>
        <p>Bu sahifa buyurtma yaratish funksiyasini test qilish uchun yaratilgan.</p>
        
        <form id="orderForm">
            <div class="form-group">
                <label for="customerName">Mijoz ismi:</label>
                <input type="text" id="customerName" name="customerName" required>
            </div>
            
            <div class="form-group">
                <label for="customerPhone">Telefon raqami:</label>
                <input type="tel" id="customerPhone" name="customerPhone" required>
            </div>
            
            <div class="form-group">
                <label for="customerEmail">Email (ixtiyoriy):</label>
                <input type="email" id="customerEmail" name="customerEmail">
            </div>
            
            <div class="form-group">
                <label for="deliveryAddress">Yetkazib berish manzili:</label>
                <textarea id="deliveryAddress" name="deliveryAddress" rows="3" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="notes">Izohlar (ixtiyoriy):</label>
                <textarea id="notes" name="notes" rows="2"></textarea>
            </div>
            
            <div class="form-group">
                <label for="productName">Mahsulot nomi:</label>
                <input type="text" id="productName" name="productName" value="Test Eshik" required>
            </div>
            
            <div class="form-group">
                <label for="quantity">Miqdor:</label>
                <input type="number" id="quantity" name="quantity" value="1" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="price">Narx:</label>
                <input type="number" id="price" name="price" value="1000000" min="0" step="1000" required>
            </div>
            
            <button type="submit" id="submitBtn">Buyurtma yaratish</button>
        </form>
        
        <div id="result"></div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://oathybjrmhtubbemjeyy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hdGh5YmpybWh0dWJiZW1qZXl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjMzOTIsImV4cCI6MjA3Mjk5OTM5Mn0.GlKHHQj1nhDGwF78Fr7zlKytRxEwXwlyRTlgEX6d4io';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Test database connection
        async function testConnection() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    showResult('error', `Database connection failed: ${error.message}`);
                } else {
                    showResult('info', '‚úÖ Database connection successful!');
                }
            } catch (err) {
                showResult('error', `Connection error: ${err.message}`);
            }
        }
        
        // Create order function
        async function createOrder(orderData) {
            try {
                // 1. Create or find customer
                const customer = await createOrFindCustomer(
                    orderData.customerPhone,
                    orderData.customerName,
                    orderData.customerEmail
                );
                
                // 2. Generate order number
                const orderNumber = `EURO-${Date.now().toString().slice(-6)}`;
                
                // 3. Calculate total amount
                const totalAmount = orderData.price * orderData.quantity;
                
                // 4. Create order
                const order = {
                    order_number: orderNumber,
                    customer_id: customer.id,
                    customer_name: orderData.customerName,
                    customer_phone: orderData.customerPhone,
                    customer_email: orderData.customerEmail || null,
                    delivery_address: orderData.deliveryAddress,
                    notes: orderData.notes || null,
                    total_amount: totalAmount,
                    products: [{
                        product_name: orderData.productName,
                        quantity: orderData.quantity,
                        price: orderData.price
                    }],
                    status: 'pending'
                };
                
                const { data, error } = await supabase
                    .from('orders')
                    .insert([order])
                    .select()
                    .single();
                
                if (error) {
                    throw new Error(`Supabase error: ${error.message}`);
                }
                
                return data;
                
            } catch (error) {
                console.error('Error creating order:', error);
                throw error;
            }
        }
        
        // Create or find customer
        async function createOrFindCustomer(phone, name, email) {
            // First, try to find existing customer
            const { data: existingCustomer } = await supabase
                .from('customers')
                .select('*')
                .eq('phone', phone)
                .single();
            
            if (existingCustomer) {
                return existingCustomer;
            }
            
            // Create new customer
            const { data, error } = await supabase
                .from('customers')
                .insert([{
                    phone,
                    name,
                    email: email || null
                }])
                .select()
                .single();
            
            if (error) {
                throw new Error(`Customer creation error: ${error.message}`);
            }
            
            return data;
        }
        
        // Show result
        function showResult(type, message) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
        }
        
        // Form submission
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Buyurtma yaratilmoqda...';
            
            try {
                const formData = new FormData(e.target);
                const orderData = {
                    customerName: formData.get('customerName'),
                    customerPhone: formData.get('customerPhone'),
                    customerEmail: formData.get('customerEmail'),
                    deliveryAddress: formData.get('deliveryAddress'),
                    notes: formData.get('notes'),
                    productName: formData.get('productName'),
                    quantity: parseInt(formData.get('quantity')),
                    price: parseFloat(formData.get('price'))
                };
                
                const order = await createOrder(orderData);
                
                showResult('success', `
                    <h3>‚úÖ Buyurtma muvaffaqiyatli yaratildi!</h3>
                    <p><strong>Buyurtma raqami:</strong> ${order.order_number}</p>
                    <p><strong>Mijoz:</strong> ${order.customer_name}</p>
                    <p><strong>Telefon:</strong> ${order.customer_phone}</p>
                    <p><strong>Jami summa:</strong> ${order.total_amount.toLocaleString()} so'm</p>
                    <p><strong>Holat:</strong> ${order.status}</p>
                    <p><strong>Yaratilgan vaqt:</strong> ${new Date(order.created_at).toLocaleString()}</p>
                `);
                
                // Reset form
                e.target.reset();
                
            } catch (error) {
                showResult('error', `
                    <h3>‚ùå Xatolik yuz berdi!</h3>
                    <p><strong>Xatolik:</strong> ${error.message}</p>
                    <p>Iltimos, qaytadan urinib ko'ring.</p>
                `);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Buyurtma yaratish';
            }
        });
        
        // Test connection on page load
        window.addEventListener('load', testConnection);
    </script>
</body>
</html>
