import{s as y,c as _,u as C,j as e}from"./index-D1bh6Jp5.js";import{r as f}from"./vendor-bd6wVIFv.js";import{m as p,o as E,c as T,b as O,C as P,d as z,v as U,H as R}from"./ui-CR5CjSar.js";import"./supabase-ByzS6PGn.js";class D{async sendPushNotification(n,l,o,c){try{console.log("📤 Sending push notification to user:",n);const{data:i,error:d}=await y.from("push_subscriptions").select("subscription").eq("user_id",n);if(d){console.error("❌ Error fetching subscriptions:",d);return}if(!i||i.length===0){console.log("⚠️ No push subscriptions found for user:",n);return}for(const u of i)await this.sendToSubscription(u.subscription,l,o,c);console.log("✅ Push notifications sent successfully")}catch(i){console.error("❌ Error sending push notification:",i)}}async sendToSubscription(n,l,o,c){try{console.log("📱 Would send push notification:",{subscription:n,title:l,body:o,data:c})}catch(i){console.error("❌ Error sending to subscription:",i)}}async notifyOrderStatusChange(n,l,o){const c={pending:"Buyurtmangiz qabul qilindi!",confirmed:"Buyurtmangiz tasdiqlandi!",processing:"Buyurtmangiz tayyorlanmoqda!",ready:"Buyurtmangiz tayyor!",delivered:"Buyurtmangiz yetkazildi!",cancelled:"Buyurtmangiz bekor qilindi!"},i="🔔 Buyurtma Holati O'zgartirildi",d=c[l]||"Buyurtmangiz holati o'zgartirildi",u={orderId:n,status:l,type:"order_status_change"};await this.sendPushNotification(o,i,d,u)}}const $=new D,j=[{key:"pending",label:"Kutilmoqda",icon:O,color:"text-yellow-600"},{key:"confirmed",label:"Tasdiqlangan",icon:P,color:"text-blue-600"},{key:"processing",label:"Tayyorlanmoqda",icon:z,color:"text-purple-600"},{key:"shipped",label:"Yuborilgan",icon:U,color:"text-indigo-600"},{key:"delivered",label:"Yetkazilgan",icon:R,color:"text-green-600"}];function H(){const[x,n]=f.useState(""),[l,o]=f.useState([]),[c,i]=f.useState(!1),[d,u]=f.useState(""),[w,S]=f.useState(null),{user:g}=_();C(),f.useEffect(()=>{if(g){(async()=>{try{const{error:s}=await y.from("orders").select("count").limit(1);s?console.error("❌ Supabase connection error:",s):console.log("✅ Supabase connection OK")}catch(s){console.error("❌ Supabase test error:",s)}})(),N();const r=y.channel("customer-orders-realtime",{config:{broadcast:{self:!0},presence:{key:"customer-orders"}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},s=>{console.log("🆕 New order added:",s.new),console.log("🔄 Refreshing orders list..."),N()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},s=>{console.log("✏️ Order updated:",s.new),console.log("🔄 Payload details:",{new:s.new,old:s.old,eventType:s.eventType,schema:s.schema,table:s.table});const m=s.old?.status,a=s.new?.status;if(m&&a&&m!==a){if(console.log("🔔 Order status changed:",{oldStatus:m,newStatus:a}),typeof window<"u"&&"Notification"in window&&Notification.permission==="granted"){const b={pending:"Buyurtmangiz qabul qilindi va ko'rib chiqilmoqda",confirmed:"Buyurtmangiz tasdiqlandi va ishlab chiqarishga yuborildi",processing:"Buyurtmangiz ishlab chiqarilmoqda",ready:"Buyurtmangiz tayyor! Yetkazib berish uchun tayyorlanmoqda",shipped:"Buyurtmangiz yuborildi va yo'lda",delivered:"Buyurtmangiz yetkazib berildi! Rahmat!",cancelled:"Buyurtmangiz bekor qilindi"}[a]||`Buyurtma holati o'zgartirildi: ${a}`;new Notification(`Eurodoor - Buyurtma #${s.new.order_number}`,{body:b,icon:"/favicon.ico",tag:`order-${s.new.order_number}`,requireInteraction:!0})}if(g&&g.id)try{$.notifyOrderStatusChange(s.new.order_number,a,g.id).then(()=>{console.log("✅ Push notification sent to user device")}).catch(h=>{console.error("❌ Push notification error:",h)})}catch(h){console.error("❌ Push notification error:",h)}}o(h=>h.map(b=>b.id===s.new.id?(console.log("✅ Updating order status:",s.new.status),S(new Date),{...b,...s.new}):b))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"orders"},s=>{console.log("🗑️ Order deleted:",s.old),console.log("🔄 Updating local state..."),o(m=>m.filter(a=>a.id!==s.old.id))}).subscribe(s=>{console.log("📡 Customer orders subscription status:",s),s==="SUBSCRIBED"?(console.log("✅ Successfully subscribed to customer orders real-time updates"),console.log("🎯 Real-time sync is now active for customer!")):s==="CHANNEL_ERROR"?(console.error("❌ Channel error in customer orders subscription"),console.error("❌ Real-time sync will not work!")):s==="TIMED_OUT"?(console.error("⏰ Customer orders subscription timed out"),console.error("❌ Real-time sync will not work!")):s==="CLOSED"?console.log("🔌 Customer orders subscription closed"):console.log("📡 Customer orders subscription status:",s)});return()=>{r.unsubscribe()}}},[g]);const N=async()=>{if(g)try{i(!0);const{data:t,error:r}=await y.from("orders").select("*").eq("customer_email",g.email).order("created_at",{ascending:!1});if(r)throw r;o(t||[])}catch(t){console.error("Buyurtmalarni yuklashda xatolik:",t),u("Buyurtmalarni yuklashda xatolik yuz berdi")}finally{i(!1)}},v=async()=>{if(x.trim())try{i(!0),u("");const{data:t,error:r}=await y.from("orders").select("*").or(`order_number.ilike.%${x}%,customer_phone.ilike.%${x}%,customer_email.ilike.%${x}%`).order("created_at",{ascending:!1});if(r)throw r;o(t||[]),!t||t.length===0?u("Buyurtma topilmadi"):console.log("✅ Orders loaded, real-time updates handled by global notification service")}catch(t){console.error("Qidiruvda xatolik:",t),u("Qidiruvda xatolik yuz berdi")}finally{i(!1)}},k=t=>j.findIndex(r=>r.key===t),B=t=>new Date(t).toLocaleDateString("uz-UZ",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),q=t=>new Intl.NumberFormat("uz-UZ",{style:"currency",currency:"UZS",minimumFractionDigits:0}).format(t);return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 py-12",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-white mb-4",children:"Buyurtma Holatini Kuzatish"}),e.jsx("p",{className:"text-gray-300 text-lg",children:"Buyurtmalaringizning holatini real vaqtda kuzating"})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-2xl p-6 mb-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",value:x,onChange:t=>n(t.target.value),placeholder:"Buyurtma raqami, telefon yoki email orqali qidiring",className:"w-full pl-10 pr-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent",onKeyPress:t=>t.key==="Enter"&&v()})]})}),e.jsx("button",{onClick:v,disabled:c||!x.trim(),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:c?"Qidirilmoqda...":"Qidirish"})]}),w&&e.jsxs("div",{className:"mt-4 flex items-center justify-center text-sm text-green-400",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"}),"Oxirgi yangilanish: ",w.toLocaleTimeString("uz-UZ")]})]}),d&&e.jsx(p.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:"h-5 w-5 text-red-400 mr-2"}),e.jsx("p",{className:"text-red-300",children:d})]})}),e.jsx("div",{className:"space-y-6",children:l.map(t=>e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white/10 backdrop-blur-sm rounded-2xl p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold text-white mb-1",children:["Buyurtma #",t.order_number]}),e.jsx("p",{className:"text-gray-300",children:B(t.created_at)})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:e.jsx("span",{className:"text-2xl font-bold text-blue-400",children:q(t.total_amount)})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4 overflow-x-auto pb-2",children:j.map((r,s)=>{const m=k(t.status),a=s<=m,h=s===m,b=r.icon;return e.jsxs("div",{className:"flex flex-col items-center min-w-0 flex-1",children:[e.jsx("div",{className:`w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center mb-2 ${a?"bg-blue-600":"bg-gray-600"}`,children:e.jsx(b,{className:`h-4 w-4 md:h-5 md:w-5 ${a?"text-white":"text-gray-400"}`})}),e.jsx("span",{className:`text-xs text-center leading-tight hidden md:block ${a?"text-white":"text-gray-400"}`,children:r.label}),h&&e.jsx("span",{className:"text-xs text-center leading-tight text-blue-400 font-medium md:hidden mt-1",children:r.label})]},r.key)})}),e.jsxs("div",{className:"relative hidden md:block",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute top-0 left-0 h-1 bg-blue-600 rounded-full transition-all duration-500",style:{width:`${k(t.status)/(j.length-1)*100}%`}})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-3",children:"Mijoz Ma'lumotlari"}),e.jsxs("div",{className:"space-y-2 text-gray-300",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Ism:"})," ",t.customer_name]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Telefon:"})," ",t.customer_phone]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",t.customer_email]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Manzil:"})," ",t.delivery_address]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-3",children:"Mahsulotlar"}),e.jsx("div",{className:"space-y-2",children:t.products?.map((r,s)=>e.jsxs("div",{className:"text-gray-300",children:[e.jsx("p",{className:"font-medium",children:r.name}),e.jsxs("p",{className:"text-sm",children:["Miqdor: ",r.quantity," | Narx: ",q(r.price*r.quantity)]})]},s))})]})]}),t.notes&&e.jsxs("div",{className:"mt-6 p-4 bg-white/5 rounded-lg",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-2",children:"Qo'shimcha Izoh"}),e.jsx("p",{className:"text-gray-300",children:t.notes})]})]},t.id))}),l.length===0&&!c&&!d&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(z,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Buyurtmalar topilmadi"}),e.jsx("p",{className:"text-gray-300",children:"Buyurtma raqami, telefon yoki email orqali qidiring"})]})]})})})}export{H as default};
