import{c as q,u as T,s as u,j as e}from"./index-D_r632up.js";import{r as n}from"./vendor-bd6wVIFv.js";import{m as g,l as z,t as O,j as U,C as B,n as v,v as D,H as I}from"./ui-DElh6nK7.js";import"./supabase-ByzS6PGn.js";const b=[{key:"pending",label:"Kutilmoqda",icon:U,color:"text-yellow-600"},{key:"confirmed",label:"Tasdiqlangan",icon:B,color:"text-blue-600"},{key:"processing",label:"Tayyorlanmoqda",icon:v,color:"text-purple-600"},{key:"shipped",label:"Yuborilgan",icon:D,color:"text-indigo-600"},{key:"delivered",label:"Yetkazilgan",icon:I,color:"text-green-600"}];function A(){const[l,k]=n.useState(""),[f,o]=n.useState([]),[x,c]=n.useState(!1),[h,d]=n.useState(""),[p,S]=n.useState(null),{user:m}=q();T(),n.useEffect(()=>{if(m){(async()=>{try{const{error:t}=await u.from("orders").select("count").limit(1);t?console.error("❌ Supabase connection error:",t):console.log("✅ Supabase connection OK")}catch(t){console.error("❌ Supabase test error:",t)}})(),y();const r=u.channel("customer-orders-realtime",{config:{broadcast:{self:!0},presence:{key:"customer-orders"}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"orders"},t=>{console.log("🆕 New order added:",t.new),console.log("🔄 Refreshing orders list..."),y()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders"},t=>{console.log("✏️ Order updated:",t.new),console.log("🔄 Payload details:",{new:t.new,old:t.old,eventType:t.eventType,schema:t.schema,table:t.table}),o(i=>i.map(a=>a.id===t.new.id?(console.log("✅ Updating order status:",t.new.status),S(new Date),{...a,...t.new}):a))}).on("postgres_changes",{event:"DELETE",schema:"public",table:"orders"},t=>{console.log("🗑️ Order deleted:",t.old),console.log("🔄 Updating local state..."),o(i=>i.filter(a=>a.id!==t.old.id))}).subscribe(t=>{console.log("📡 Customer orders subscription status:",t),t==="SUBSCRIBED"?(console.log("✅ Successfully subscribed to customer orders real-time updates"),console.log("🎯 Real-time sync is now active for customer!")):t==="CHANNEL_ERROR"?(console.error("❌ Channel error in customer orders subscription"),console.error("❌ Real-time sync will not work!")):t==="TIMED_OUT"?(console.error("⏰ Customer orders subscription timed out"),console.error("❌ Real-time sync will not work!")):t==="CLOSED"?console.log("🔌 Customer orders subscription closed"):console.log("📡 Customer orders subscription status:",t)});return()=>{r.unsubscribe()}}},[m]);const y=async()=>{if(m)try{c(!0);const{data:s,error:r}=await u.from("orders").select("*").eq("customer_email",m.email).order("created_at",{ascending:!1});if(r)throw r;o(s||[])}catch(s){console.error("Buyurtmalarni yuklashda xatolik:",s),d("Buyurtmalarni yuklashda xatolik yuz berdi")}finally{c(!1)}},j=async()=>{if(l.trim())try{c(!0),d("");const{data:s,error:r}=await u.from("orders").select("*").or(`order_number.ilike.%${l}%,customer_phone.ilike.%${l}%,customer_email.ilike.%${l}%`).order("created_at",{ascending:!1});if(r)throw r;o(s||[]),!s||s.length===0?d("Buyurtma topilmadi"):console.log("✅ Orders loaded, real-time updates handled by global notification service")}catch(s){console.error("Qidiruvda xatolik:",s),d("Qidiruvda xatolik yuz berdi")}finally{c(!1)}},N=s=>b.findIndex(r=>r.key===s),C=s=>new Date(s).toLocaleDateString("uz-UZ",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),w=s=>new Intl.NumberFormat("uz-UZ",{style:"currency",currency:"UZS",minimumFractionDigits:0}).format(s);return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 py-12",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-white mb-4",children:"Buyurtma Holatini Kuzatish"}),e.jsx("p",{className:"text-gray-300 text-lg",children:"Buyurtmalaringizning holatini real vaqtda kuzating"})]}),e.jsxs("div",{className:"bg-white/10 backdrop-blur-sm rounded-2xl p-6 mb-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"}),e.jsx("input",{type:"text",value:l,onChange:s=>k(s.target.value),placeholder:"Buyurtma raqami, telefon yoki email orqali qidiring",className:"w-full pl-10 pr-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent",onKeyPress:s=>s.key==="Enter"&&j()})]})}),e.jsx("button",{onClick:j,disabled:x||!l.trim(),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:x?"Qidirilmoqda...":"Qidirish"})]}),p&&e.jsxs("div",{className:"mt-4 flex items-center justify-center text-sm text-green-400",children:[e.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"}),"Oxirgi yangilanish: ",p.toLocaleTimeString("uz-UZ")]})]}),h&&e.jsx(g.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-red-500/20 border border-red-500/30 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"h-5 w-5 text-red-400 mr-2"}),e.jsx("p",{className:"text-red-300",children:h})]})}),e.jsx("div",{className:"space-y-6",children:f.map(s=>e.jsxs(g.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white/10 backdrop-blur-sm rounded-2xl p-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-xl font-semibold text-white mb-1",children:["Buyurtma #",s.order_number]}),e.jsx("p",{className:"text-gray-300",children:C(s.created_at)})]}),e.jsx("div",{className:"mt-4 md:mt-0",children:e.jsx("span",{className:"text-2xl font-bold text-blue-400",children:w(s.total_amount)})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-4 overflow-x-auto pb-2",children:b.map((r,t)=>{const i=N(s.status),a=t<=i,_=t===i,E=r.icon;return e.jsxs("div",{className:"flex flex-col items-center min-w-0 flex-1",children:[e.jsx("div",{className:`w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center mb-2 ${a?"bg-blue-600":"bg-gray-600"}`,children:e.jsx(E,{className:`h-4 w-4 md:h-5 md:w-5 ${a?"text-white":"text-gray-400"}`})}),e.jsx("span",{className:`text-xs text-center leading-tight hidden md:block ${a?"text-white":"text-gray-400"}`,children:r.label}),_&&e.jsx("span",{className:"text-xs text-center leading-tight text-blue-400 font-medium md:hidden mt-1",children:r.label})]},r.key)})}),e.jsxs("div",{className:"relative hidden md:block",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gray-600 rounded-full"}),e.jsx("div",{className:"absolute top-0 left-0 h-1 bg-blue-600 rounded-full transition-all duration-500",style:{width:`${N(s.status)/(b.length-1)*100}%`}})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-3",children:"Mijoz Ma'lumotlari"}),e.jsxs("div",{className:"space-y-2 text-gray-300",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Ism:"})," ",s.customer_name]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Telefon:"})," ",s.customer_phone]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Email:"})," ",s.customer_email]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Manzil:"})," ",s.delivery_address]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-3",children:"Mahsulotlar"}),e.jsx("div",{className:"space-y-2",children:s.products?.map((r,t)=>e.jsxs("div",{className:"text-gray-300",children:[e.jsx("p",{className:"font-medium",children:r.name}),e.jsxs("p",{className:"text-sm",children:["Miqdor: ",r.quantity," | Narx: ",w(r.price*r.quantity)]})]},t))})]})]}),s.notes&&e.jsxs("div",{className:"mt-6 p-4 bg-white/5 rounded-lg",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-2",children:"Qo'shimcha Izoh"}),e.jsx("p",{className:"text-gray-300",children:s.notes})]})]},s.id))}),f.length===0&&!x&&!h&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(v,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"Buyurtmalar topilmadi"}),e.jsx("p",{className:"text-gray-300",children:"Buyurtma raqami, telefon yoki email orqali qidiring"})]})]})})})}export{A as default};
