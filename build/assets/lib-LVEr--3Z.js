import{c as e}from"./supabase-DJJ3pIfk.js";const r=e("https://oathybjrmhtubbemjeyy.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hdGh5YmpybWh0dWJiZW1qZXl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjMzOTIsImV4cCI6MjA3Mjk5OTM5Mn0.GlKHHQj1nhDGwF78Fr7zlKytRxEwXwlyRTlgEX6d4io",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"},realtime:{params:{eventsPerSecond:2,heartbeatIntervalMs:3e4,reconnectAfterMs:[1e3,2e3,5e3,1e4]}},global:{headers:{"X-Client-Info":"eurodoor-customer-panel","Cache-Control":"max-age=600"}},db:{schema:"public"}}),t={async checkNewSystemAvailable(){try{const{error:e}=await r.from("customer_registrations").select("id").limit(1);return!e}catch(e){return!1}},async checkOldSystemAvailable(){try{const{error:e}=await r.from("customers").select("id").limit(1);return(!e||"PGRST204"!==e.code&&"PGRST116"!==e.code&&!e.message?.includes("406"))&&!e}catch(e){return!1}},async migrateCustomer(e){try{const t={id:e.id,name:e.name,phone:e.phone,password:"migrated_"+Date.now(),is_active:!0,is_verified:!0},{data:s,error:a}=await r.from("customer_registrations").insert([t]).select();return a?{success:!1,error:a.message}:{success:!0}}catch(t){return{success:!1,error:t.message}}},async getCustomerData(e){try{try{const t=r.from("customer_registrations").select("*").eq("id",e).single(),s=new Promise((e,r)=>setTimeout(()=>r(new Error("Query timeout after 5 seconds")),5e3)),{data:a,error:o}=await Promise.race([t,s]);if(!o&&a)return{data:a,source:"new"}}catch(t){}try{const t=r.from("customers").select("*").eq("id",e).single(),s=new Promise((e,r)=>setTimeout(()=>r(new Error("Query timeout after 5 seconds")),5e3)),{data:a,error:o}=await Promise.race([t,s]);if(!o&&a)return{data:a,source:"old"}}catch(s){}return{data:null,source:null}}catch(a){return{data:null,source:null}}},async createCustomer(e){try{if(await this.checkNewSystemAvailable()){const t={id:e.id,name:e.name,phone:e.phone,password:"temp_password_"+Date.now(),is_active:!0,is_verified:!0},{data:s,error:a}=await r.from("customer_registrations").insert([t]).select();return a?{success:!1,error:a.message}:{success:!0,data:s}}if(await this.checkOldSystemAvailable()){const t={id:e.id,name:e.name,phone:e.phone,email:e.email||null},{data:s,error:a}=await r.from("customers").insert([t]).select();return a?{success:!1,error:a.message}:{success:!0,data:s}}return{success:!1,error:"No customer system available"}}catch(t){return{success:!1,error:t.message}}},async updateCustomer(e,t){try{const o={...t,updated_at:(new Date).toISOString()};try{const t=r.from("customer_registrations").update(o).eq("id",e).select(),s=new Promise((e,r)=>setTimeout(()=>r(new Error("Update timeout after 10 seconds")),1e4)),{data:a,error:c}=await Promise.race([t,s]);if(c)throw c;return{success:!0,data:a}}catch(s){try{const t=r.from("customers").update(o).eq("id",e).select(),s=new Promise((e,r)=>setTimeout(()=>r(new Error("Update timeout after 10 seconds")),1e4)),{data:a,error:c}=await Promise.race([t,s]);if(c)throw c;return{success:!0,data:a}}catch(a){return{success:!1,error:`Update failed: ${a.message}`}}}}catch(o){return{success:!1,error:o.message}}}},s=Object.freeze(Object.defineProperty({__proto__:null,customerMigrationApi:t},Symbol.toStringTag,{value:"Module"})),a={}?.VITE_VAPID_PUBLIC_KEY||"BDKmEIAbWtoGMgyNKmKljaJVofmw81mqRz54IMqBRH0JZcdGCSG2pBfSM_cqfHRVGIvBzgw9Imm7Gqnp1eGVWUU";function o(e){const r=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=atob(r);return Uint8Array.from([...t].map(e=>e.charCodeAt(0)))}function c(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window}function n(){const e=u(),r=localStorage.getItem("notif:asked"),t=!!e;return c()&&"default"===Notification.permission&&!r&&t}function i(){try{localStorage.setItem("notif:asked","1")}catch{}}function u(){try{return localStorage.getItem("user:id")}catch{return null}}function d(e){try{localStorage.setItem("user:id",e)}catch{}}async function m(e){if(!c())throw new Error("Push not supported");const{data:{session:t}}=await r.auth.getSession();if(!t||!t.user)throw new Error("User not authenticated");if("granted"!==await Notification.requestPermission())throw new Error("Permission denied");const s=await async function(){if(!("serviceWorker"in navigator))throw new Error("SW not supported");return navigator.serviceWorker.register("/sw.js",{scope:"/"})}();let n;try{n=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:o(a)})}catch(i){throw new Error(`Push subscription failed: ${i}`)}try{const t={user_id:e,subscription:n.toJSON(),created_at:(new Date).toISOString()},{data:s,error:a}=await r.from("push_subscriptions").upsert(t,{onConflict:"user_id"});if(a)throw a;return s}catch(i){throw i}}let l=null,h=0;const w={async testConnection(){try{const{data:e,error:t}=await r.from("products").select("*").limit(5);return t?{success:!1,error:t.message}:{success:!0,data:e}}catch(e){return{success:!1,error:"Connection failed"}}},async getAllProducts(e=!1){if(!e&&l&&Date.now()-h<6e5)return l;try{const{data:e,error:t}=await r.from("products").select("id, model_name, price, image_url, dimensions, material, security_class, thickness, lock_stages, stock_quantity, description, is_active, created_at, updated_at").order("created_at",{ascending:!1}).limit(100);if(t)throw new Error(`Database error: ${t.message}`);const s=e?.filter(e=>!1!==e.is_active)||[];return l=s,h=Date.now(),l}catch(t){throw t}},async getProductById(e){try{if(l){const r=l.find(r=>r.id===e);if(r)return r}const{data:t,error:s}=await r.from("products").select("id, model_name, price, image_url, dimensions, material, security_class, thickness, lock_stages, stock_quantity, description, is_active, created_at, updated_at").eq("id",e).eq("is_active",!0).single();if(s)throw new Error(`Database error: ${s.message}`);return t}catch(t){throw t}},clearCache(){l=null,h=0}},y={async createOrder(e){try{const t={order_number:`EURO-${Date.now().toString().slice(-6)}`,customer_name:e.customer_name,customer_phone:e.customer_phone,customer_email:e.customer_email,delivery_address:e.delivery_address,notes:e.notes,total_amount:e.total_amount,products:e.products,status:"pending"},{data:s,error:a}=await r.from("orders").insert([t]).select().single();if(a)throw new Error(`Supabase error: ${a.message}`);return s}catch(t){throw t}},async getOrderByNumber(e){try{const{data:t,error:s}=await r.from("orders").select("*").eq("order_number",e).single();return s?null:t}catch(t){return null}},async getOrdersByCustomer(e){try{const{data:t,error:s}=await r.from("orders").select("*").eq("customer_phone",e).order("created_at",{ascending:!1});if(s)throw new Error(`Supabase error: ${s.message}`);return t||[]}catch(t){throw t}},async getAllOrders(){try{const{data:e,error:t}=await r.from("orders").select("*").order("created_at",{ascending:!1});if(t)throw new Error(`Supabase error: ${t.message}`);return e||[]}catch(e){throw e}},async updateOrderStatus(e,t){try{const{error:s}=await r.from("orders").update({status:t}).eq("id",e);if(s)throw new Error(`Supabase error: ${s.message}`);return!0}catch(s){throw s}},async getOrderItems(e){try{const{data:t,error:s}=await r.from("order_items").select("*").eq("order_id",e).order("created_at",{ascending:!0});if(s)throw new Error(`Supabase error: ${s.message}`);return t||[]}catch(t){throw t}},subscribeToOrders:e=>r.channel("orders").on("postgres_changes",{event:"*",schema:"public",table:"orders"},e).subscribe()},g={async createCustomer(e){try{const{data:t,error:s}=await r.from("customers").insert([e]).select().single();if(s)throw new Error(`Supabase error: ${s.message}`);return t}catch(t){throw t}},async getCustomerByPhone(e){try{const{data:t,error:s}=await r.from("customers").select("*").eq("phone",e).single();return s?null:t}catch(t){return null}},async updateCustomer(e,t){try{const{error:s}=await r.from("customers").update(t).eq("id",e);if(s)throw new Error(`Supabase error: ${s.message}`);return!0}catch(s){throw s}},async upsertCustomer(e){try{const r=await this.getCustomerByPhone(e.phone);if(r)return await this.updateCustomer(r.id,e),{...r,...e};{const r=await this.createCustomer(e);if(!r)throw new Error("Failed to create customer");return r}}catch(r){throw r}},async getAllCustomers(){try{const{data:e,error:t}=await r.from("customers").select("*").eq("is_active",!0).order("created_at",{ascending:!1});if(t)throw new Error(`Supabase error: ${t.message}`);return e||[]}catch(e){throw e}},subscribeToCustomers:e=>r.channel("customers").on("postgres_changes",{event:"*",schema:"public",table:"customers"},e).subscribe()},f={async testOrderStatusChange(e,t){try{const{error:s}=await r.from("orders").update({status:t,updated_at:(new Date).toISOString()}).eq("order_number",e);return s?{success:!1,error:s.message}:{success:!0,message:"Order status updated"}}catch(s){return{success:!1,error:"Test failed"}}},async checkOrderExists(e){try{const{data:t,error:s}=await r.from("orders").select("*").eq("order_number",e).single();return s?{success:!1,error:"Order not found"}:{success:!0,data:t}}catch(t){return{success:!1,error:"Check failed"}}},async getAllOrders(){try{const{data:e,error:t}=await r.from("orders").select("*").order("created_at",{ascending:!1}).limit(10);return t?{success:!1,error:t.message}:{success:!0,data:e}}catch(e){return{success:!1,error:"Get orders failed"}}}};"undefined"!=typeof window&&(window.testNotificationSystem=f);const p=new class{async sendPushNotification(e,t,s,a){try{const{data:o,error:c}=await r.from("push_subscriptions").select("subscription").eq("user_id",e);if(c)return;if(!o||0===o.length)return;for(const e of o)await this.sendToSubscription(e.subscription,t,s,a)}catch(o){}}async sendToSubscription(e,r,t,s){}async notifyOrderStatusChange(e,r,t){const s={pending:"Buyurtmangiz qabul qilindi!",confirmed:"Buyurtmangiz tasdiqlandi!",processing:"Buyurtmangiz tayyorlanmoqda!",ready:"Buyurtmangiz tayyor!",delivered:"Buyurtmangiz yetkazildi!",cancelled:"Buyurtmangiz bekor qilindi!"}[r]||"Buyurtmangiz holati o'zgartirildi",a={orderId:e,status:r,type:"order_status_change"};await this.sendPushNotification(t,"🔔 Buyurtma Holati O'zgartirildi",s,a)}};export{d as a,n as b,t as c,g as d,m as e,p as f,u as g,s as h,c as i,i as m,y as o,w as p,r as s,f as t};
