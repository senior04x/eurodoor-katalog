<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Subscription Test - Eurodoor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-entry.error { color: #dc3545; }
        .log-entry.success { color: #28a745; }
        .log-entry.warning { color: #ffc107; }
        .log-entry.info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Push Subscription Test - Eurodoor</h1>
        
        <div id="status" class="status info">
            Initializing...
        </div>

        <div>
            <h3>Test Controls</h3>
            <button onclick="testPushSubscription()">Test Push Subscription</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="checkSupabaseTable()">Check Supabase Table</button>
        </div>

        <div>
            <h3>Browser Support</h3>
            <div id="browserSupport"></div>
        </div>

        <div>
            <h3>Current User</h3>
            <div id="currentUser"></div>
        </div>

        <div>
            <h3>Test Logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script type="module">
        // Import the notification service
        import { 
            ensurePushSubscription, 
            getCurrentUserId, 
            isPushSupported, 
            getNotificationPermission,
            VAPID_PUBLIC_KEY 
        } from './src/lib/notificationService.js';

        // Make functions available globally
        window.ensurePushSubscription = ensurePushSubscription;
        window.getCurrentUserId = getCurrentUserId;
        window.isPushSupported = isPushSupported;
        window.getNotificationPermission = getNotificationPermission;
        window.VAPID_PUBLIC_KEY = VAPID_PUBLIC_KEY;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function updateBrowserSupport() {
            const supportDiv = document.getElementById('browserSupport');
            const support = {
                'Service Worker': 'serviceWorker' in navigator,
                'Push Manager': 'PushManager' in window,
                'Notifications': 'Notification' in window,
                'VAPID Key': !!VAPID_PUBLIC_KEY
            };

            let html = '';
            for (const [feature, supported] of Object.entries(support)) {
                const status = supported ? '‚úÖ' : '‚ùå';
                const className = supported ? 'success' : 'error';
                html += `<div class="status ${className}">${status} ${feature}</div>`;
            }
            supportDiv.innerHTML = html;
        }

        function updateCurrentUser() {
            const userDiv = document.getElementById('currentUser');
            const userId = getCurrentUserId();
            if (userId) {
                userDiv.innerHTML = `<div class="status success">‚úÖ User ID: ${userId}</div>`;
            } else {
                userDiv.innerHTML = `<div class="status warning">‚ö†Ô∏è No user logged in</div>`;
            }
        }

        async function testPushSubscription() {
            log('üöÄ Starting push subscription test...', 'info');
            
            const userId = getCurrentUserId();
            if (!userId) {
                log('‚ùå No user logged in. Please log in first.', 'error');
                updateStatus('No user logged in', 'error');
                return;
            }

            if (!isPushSupported()) {
                log('‚ùå Push notifications not supported in this browser', 'error');
                updateStatus('Push not supported', 'error');
                return;
            }

            const permission = getNotificationPermission();
            log(`üìã Current notification permission: ${permission}`, 'info');

            try {
                log('üì§ Calling ensurePushSubscription...', 'info');
                const result = await ensurePushSubscription(userId);
                log('‚úÖ Push subscription test completed successfully!', 'success');
                log(`üìä Result: ${JSON.stringify(result, null, 2)}`, 'info');
                updateStatus('Push subscription test passed!', 'success');
            } catch (error) {
                log(`‚ùå Push subscription test failed: ${error.message}`, 'error');
                log(`üîç Error details: ${JSON.stringify(error, null, 2)}`, 'error');
                updateStatus('Push subscription test failed', 'error');
            }
        }

        async function checkSupabaseTable() {
            log('üîç Checking Supabase push_subscriptions table...', 'info');
            
            try {
                // This would require the Supabase client to be available
                // For now, just log that we would check the table
                log('üìã To check the table, go to your Supabase dashboard and run:', 'info');
                log('SELECT * FROM push_subscriptions ORDER BY created_at DESC;', 'info');
                log('üí° Or check the browser console for the subscription save logs', 'info');
            } catch (error) {
                log(`‚ùå Error checking table: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('üßπ Logs cleared', 'info');
        }

        // Make functions available globally
        window.testPushSubscription = testPushSubscription;
        window.checkSupabaseTable = checkSupabaseTable;
        window.clearLogs = clearLogs;
        window.log = log;

        // Initialize
        updateBrowserSupport();
        updateCurrentUser();
        updateStatus('Ready for testing', 'success');
        log('üéØ Push subscription test page loaded', 'success');
        log(`üîë VAPID Key available: ${!!VAPID_PUBLIC_KEY}`, 'info');
        log(`üë§ Current user: ${getCurrentUserId() || 'None'}`, 'info');
    </script>
</body>
</html>
